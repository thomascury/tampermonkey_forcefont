// ==UserScript==
// @name         Force Font - JetBrains Mono
// @namespace    https://github.com/thomascury
// @version      0.14
// @description  Force website fonts to a Monospaced font (JetBrains Mono), tries to preserve icons and adds icons/emoji support through a Symbols font (Noto Emoji)
// @author       You
// @homepage     https://github.com/thomascury/tampermonkey_forcefont
// @updateURL    https://raw.githubusercontent.com/thomascury/tampermonkey_forcefont/refs/heads/main/userscript_forcefont
// @downloadURL  https://raw.githubusercontent.com/thomascury/tampermonkey_forcefont/refs/heads/main/userscript_forcefont
// @match        *://*/*
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @resource     MonoFont https://fonts.googleapis.com/css?family=JetBrains+Mono:wght@400;700&display=swap
// @resource     SymbolsFont https://fonts.googleapis.com/css?family=Noto+Emoji:wght@400;700&display=swap
// @run-at       document-start
// ==/UserScript==

// https://greasyfork.org/en/scripts/522884-default-trusted-types-policy-for-all-pages/code
if (typeof trustedTypes !== 'undefined' && trustedTypes.defaultPolicy === null) {
  let s = s => s, [p, q, r] = [s, s, s]; s = trustedTypes;
  s.createPolicy('default', { createHTML: s => p(s), createScriptURL: s => q(s), createScript: s => r(s) });
  s.$Ω = s.createPolicy;
  s.createPolicy = function (a, b) {
    if (a === 'default' && s) {
      s = 0;
      const { createHTML: x, createScriptURL: y, createScript: z } = b;
      x && (p = x);
      y && (q = y);
      z && (r = z);
      return this.defaultPolicy;
    }
    return this.$Ω(...arguments);
  };
}

(function() {
    'use strict';

    // Load Mono & Symbols fonts
    var MonoFont = GM_getResourceText("MonoFont");
    var SymbolsFont = GM_getResourceText("SymbolsFont");
    GM_addStyle(MonoFont);
    GM_addStyle(SymbolsFont);

    // Define the new font family
    let newFont = '"JetBrains Mono", "Noto Emoji", sans-serif';

    // Whitelist of classes and elements to ignore
    let whitelist = [
        '.fa', '.fas', '.far', '.fal', '.fad', // Awesome font
        '.katex', '.MathJax', // Math equations
        'i', // Icons elements
        '.docon', // MS documentation docon icons
        'code', 'pre', // Code snippets
        '.animatedRollingNumberHost', // Youtube animated numbers gets misaligned
        "[class*='heroButton']", // Sharepoint HeroButton_* class
        "[class*='vjs-']", // Video Player icons/buttons vjs-* class
        "[class*='icon']", // Any class containing 'icon', including, but not limited to: Material icons, Chess icons, Dash icons
        "[class*='symbol']", // Any class containing 'symbol', including, but not limited to: Google icons/class
    ].join(', ');


    // Create a style element
    let style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = `
        body, p, span, a, li, h1, h2, h3, h4, h5, h6, div :not(${whitelist}){
            font-family: ${newFont};
        }

        // Force back icon font because the inheritance is breaking the font when outer elements is forced to Mono/Symbols font by the script
        body, p, span, a, li, h1, h2, h3, h4, h5, h6, div [class*="heroButton"] {
            font-family: "FabricMDL2Icons";
        }

        textarea, code, tt, pre {
        }

        .post-text, .wmd-preview {
            ul, ol {
                li {
                    margin-bottom: 0;
                }
            }
        }
    `;

    // Insert the style element into the document
    document.head.appendChild(style);

    // Optional: Log to console that the script has run
    console.log('Fonts forced to JetBrains Mono');
})();
